package com.runanywhere.kotlin_starter_example.kodent.engine

import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

object HealthReportExporter {

    fun exportAsText(result: CodeHealthResult, code: String, language: String): String {
        return buildString {
            appendLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
            appendLine("â•‘          KODENT CODE HEALTH REPORT                  â•‘")
            appendLine("â•‘          Generated by Kodent â€¢ Fully Offline        â•‘")
            appendLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine()
            appendLine("Date: ${SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.getDefault()).format(Date())}")
            appendLine("Language: $language")
            appendLine("Lines Analyzed: ${code.lines().size}")
            appendLine()

            appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine("  OVERALL HEALTH: ${result.overallScore}/100")
            appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine()

            appendLine("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
            appendLine("â”‚  DIMENSION SCORES                    â”‚")
            appendLine("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            appendLine("â”‚  ğŸ› Bug Risk:      ${result.bugRisk}/10".padEnd(39) + "â”‚")
            appendLine("â”‚  âš¡ Performance:   ${result.performance}/10".padEnd(39) + "â”‚")
            appendLine("â”‚  ğŸ”’ Security:      ${result.security}/10".padEnd(39) + "â”‚")
            appendLine("â”‚  ğŸ“– Readability:   ${result.readability}/10".padEnd(39) + "â”‚")
            appendLine("â”‚  ğŸ§© Complexity:    ${result.complexity}/10".padEnd(39) + "â”‚")
            appendLine("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
            appendLine()

            // Metrics
            if (result.metrics != null) {
                val m = result.metrics
                appendLine("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
                appendLine("â”‚  CODE METRICS                        â”‚")
                appendLine("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
                appendLine("â”‚  Total Lines:      ${m.totalLines}".padEnd(39) + "â”‚")
                appendLine("â”‚  Code Lines:       ${m.codeLines}".padEnd(39) + "â”‚")
                appendLine("â”‚  Comment Lines:    ${m.commentLines}".padEnd(39) + "â”‚")
                appendLine("â”‚  Blank Lines:      ${m.blankLines}".padEnd(39) + "â”‚")
                appendLine("â”‚  Functions:        ${m.functionCount}".padEnd(39) + "â”‚")
                appendLine("â”‚  Classes:          ${m.classCount}".padEnd(39) + "â”‚")
                appendLine("â”‚  Avg Func Length:  ${m.avgFunctionLength} lines".padEnd(39) + "â”‚")
                appendLine("â”‚  Max Nesting:      ${m.maxNestingDepth}".padEnd(39) + "â”‚")
                appendLine("â”‚  val/var Ratio:    ${m.valCount}/${m.varCount}".padEnd(39) + "â”‚")
                appendLine("â”‚  Comment Ratio:    ${m.commentPercentage}%".padEnd(39) + "â”‚")
                appendLine("â”‚  Cyclomatic:       ${m.cyclomaticComplexity}".padEnd(39) + "â”‚")
                appendLine("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
                appendLine()
            }

            // Best practices
            if (result.bestPractices.isNotEmpty()) {
                appendLine("BEST PRACTICES DETECTED:")
                result.bestPractices.forEach { practice ->
                    appendLine("  âœ… $practice")
                }
                appendLine()
            }

            // Issues
            if (result.issues.isNotEmpty()) {
                val criticalCount = result.issues.count { it.severity == IssueSeverity.CRITICAL }
                val highCount = result.issues.count { it.severity == IssueSeverity.HIGH }
                val mediumCount = result.issues.count { it.severity == IssueSeverity.MEDIUM }
                val lowCount = result.issues.count { it.severity == IssueSeverity.LOW }

                appendLine("SEVERITY BREAKDOWN:")
                if (criticalCount > 0) appendLine("  ğŸ”´ Critical: $criticalCount")
                if (highCount > 0) appendLine("  ğŸŸ  High: $highCount")
                if (mediumCount > 0) appendLine("  ğŸŸ¡ Medium: $mediumCount")
                if (lowCount > 0) appendLine("  ğŸ”µ Low: $lowCount")
                appendLine()

                appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                appendLine("  DETAILED FINDINGS")
                appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                appendLine()

                result.issues.forEachIndexed { i, issue ->
                    val severityIcon = when (issue.severity) {
                        IssueSeverity.CRITICAL -> "ğŸ”´ CRITICAL"
                        IssueSeverity.HIGH -> "ğŸŸ  HIGH"
                        IssueSeverity.MEDIUM -> "ğŸŸ¡ MEDIUM"
                        IssueSeverity.LOW -> "ğŸ”µ LOW"
                    }

                    appendLine("â”€â”€â”€ Issue #${i + 1} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
                    appendLine("Severity:    $severityIcon")
                    appendLine("Title:       ${issue.title}")
                    appendLine("Description: ${issue.description}")
                    appendLine()
                }
            } else {
                appendLine("âœ… No issues found! Code is in excellent health.")
                appendLine()
            }

            appendLine("SUMMARY: ${result.summary}")
            appendLine()
            appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine("  END OF REPORT")
            appendLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine()
            appendLine("Generated by Kodent â€” Offline AI Code Analyzer")
            appendLine("No data was transmitted. All analysis performed on-device.")
        }
    }
}